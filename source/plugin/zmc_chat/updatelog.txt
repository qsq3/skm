.

測試及編寫環境：
http://www.wampserver.com/
wampserver 32bit 2.2E 、 php 5.4.3

瀏覽器：
IE8
Firefox 14.0.1
Google Chrome 20.0.1132.57
Opera 12.00
Safari 5.1.2 (安裝後只測2次，開啟後這軟體狂讀硬碟 = =，還卡卡的，也出現一次藍屏，移除不敢用了)

.

用了這個updatelog.txt方便記錄及查看修改過的東西，與社區茶坊不同，安裝說明和更新分開，各自txt檔。

readmegbk.txt  簡體安裝及使用說明文件
readmebig5.txt 繁體安裝及使用說明文件
updatelog.txt  版本更新說明，大慨也就我自已在看，查查改過什麼，有時可能隔了好幾個月才更新，會忘記...

.

前言：
之前用了許多天，大約完成了主要部份，準備與dz x2結合，於是將test.htm及zmctalk.php放至zmc_chat目錄下，
並改為/template/zmcchat01.htm及zmcchat.php

2012年3月8日：
單獨htm是用 javacript 可以重設cookie，但用成dz x2模版時，就沒法重設，
用了老半天一直用不好。

2012年3月9日：
後來找到原因，是js cookie的path和php的不同，作用域路徑不同 = =，
試了半天，放棄js的cookie，改由php來設置與讀取cookie

文字顏色，改了第3次，最後改成button
一開始的下拉框，覺的不好，訊息框上面那一排想統一都用文字
後改成 radio 開關...不太好，文字很難對齊，又改成<a href="#"></a>後點了會跳主頁...= =，
最後改成button

表情符號...頭痛許久，調用方式想了一陣子，最後用成require_once載入方式。
之前就算了...後來原本打算在zmc_chat.inc.php裡面加入掃瞄zsmile目錄的jpg png gif，
但這樣每次進入都掃一次，很沒效率...後用了一個create_smile.php執行，它會創一個zmcsmile.php，後在載入zmcsmile.php，
算是方便日後加入新的或替換表情符號，能夠簡單易用 - -。

加入字數限制，400字元，utf8的話除3，約可輸入130個中文左右，應該十分夠用了
記錄檔最大存放數120 ，雖然後台可設，但怕錯誤輸入，還是設一下限制

2012年3月10日：
名稱name，用的差不多， ' " \ 如有帶這3個符號，後續處理太麻煩了，暫時轉成* ，= =
[TO]name[/Say] 也ok

話匣子管理組 ok ， 可使用 重建表情 及 刪除記錄，也用成按鈕，原本想整在zmcchat.php，算了...這隻使用率最高，愈小隻愈好，
後用個zadmin.php按鈕點一下進這隻處理，介面也隨便用一下 = =

後台也加入 邊框 背景 背景圖 7個填入選項，測試 ok

邊框色可參考 後台 -> 界面 -> 風格管理 -> 編輯 -> 彩色區域邊框  (拉至最下方可見)

動態變更記錄檔及cookie 的2個存放時間最後進入及記錄最後更新 ok 方便後面用成各自獨立的話夾子

2012年3月11日：
將cookie去掉，改由js變數來存取上次與伺服連線time及記錄最後更新time，用了好多天，才想到用js變數就好，省去cookie

&被解析2次，會造成big5版，發簡體字亂碼，也不算亂碼是瀏覽器將不在字符集的轉成&#10進位，
但&這符號又被htmlspecialchars轉&amp;，用str_replace反轉回去一次，就可正常顯示，
算是al8的kc18問我dz7社區茶坊有人發簡體字亂碼，想了一陣子才明白，待測...目前都用utf8在搞= =，理倫上可行。

去掉 重建表情 及 刪除記錄，改成 設置介面 ，到zadmin.php另外執行。

2012年3月12日：
總算用到頁面嵌入了 = =，一嵌入後，就不會動，緊張了...獨立頁正常，嵌入不會動，後用火狐的firebug找到了\r\n，
但看不出有啥錯，猜測好像是template把它解析成換行，這個是用來作得到資料後字串切割用，後換成@@代替，
想想覺得用\r\n做切割符也不好。

forum論壇首頁嵌入部份算是 ok ，和獨立頁不同的存放檔，也用成 0 1 2 3 分別為
0 不啟用不顯示
1 討論版上方顯示
2 討論版下方顯示
3 頁底顯示 
方便切換顯示位置

各版塊顯示話夾子 ok ，各自獨立存放記錄檔，只顯示在版規下方，不然程愈來愈大隻 = =，
可手動修改要顯示位置打開/zmc_chat/zmc_chat.class.php約第141行

function forumdisplay_top(){ 為顯示在版規下方

function forumdisplay_middle(){ 為顯示在子塊上方

function forumdisplay_bottom(){ 為顯示在頁底

自行替換修改，覺得顯示在版規下方就可，畢竟非是論壇首頁，懶的在用切換顯示另2個位置 = =，麻煩

後台設置說明 key 完 = = ，真麻煩，不key說明不行

外連圖片功能，改成div隱藏式，不用js的prompt，不然每次IE都報警告= =

上傳至3個免空，測試一陣子，設置介面空白，嚇了一跳，還好一個空間沒屏錯誤，抓到第21行...之前抓以前代碼，
忘了重算要扣的字數，本機用WampServer沒測出error大概是windowsxp吧，少個/無所謂 = =，
也忘了加，返回上一頁功能...懶了...先在免空跑幾天測測，在調整。

2012年3月13日：
簡易js防灌水，後來想到應該是一連入就先啟用，避免 重新整理 後又可發言，改在一開始就使用一次。

zadmin.php 加入 js返回上一頁
也加入域名比對，要輸入域名，域名相關字串匹配正確，才能得到回傳資料

2012年3月14日：
顯示的訊息欄 showword02 這 div 限制只顯示300筆資料，如聊天超過300，則只留300筆

又抓到一個問題 = =，今天又找了個免空測試，有安全模式，結果一試，不能寫入，後用我之前寫的社區茶坊可正常寫入，怪了，
試了老半天，抓到問題點，是flock在某些主機上不支援，之前用這個函數做判斷，如果失敗，會等1秒後在寫入一次，3次後才報錯，
想想算了，現在主機性能那麼高了，該應也不會那麼塞，改做fwrite做個判斷，失敗回傳個error訊息就行。

2012年3月15日：
訊息顯示考慮了好多天，想了一陣子，最後決定還是改向社區茶坊那樣 新在上 舊在下 顯示。
之前有人建議舊上新下，但畢竟是論壇非聊天室獨立頁面，會用到瀏覽器右邊拉條上下移動，由上向下，如果新在下舊在上，
那變的和瀏覽器反方向了，操作上很不好...算是測試幾天下這覺得不好，還是改 新上舊下。

增加一個工具按鈕，把 文字顏色 表情符號 ...等先全隱藏，按下後才顯示，這樣介面就更簡潔了

bug fix 測試遊客只看不能發時，error，算是之前加入一開始就先防灌水忘了調整 $zallowsay01 位置，造成無顯示。

工具 點第2次 文字顏色 表情 外連 應該要一同隱藏才對，fix it。

2012年3月16日：
調整一些zadmin.php顯示訊息，不是刪除所有記錄，應該是刪除 某檔 內聊天記錄

找了一個css代碼，處理 Google Chrome 無法顯示 12px以下的字體大小，測試 Google Chrome 17.0.963.79 可行。

時間顯示部份調整，改為 月-日 時：分

取消獨立顯示頁，div右邊拉條，全顯示用瀏覽器拉條就行了，這樣較方便。

2012年3月19日：
停了數天...在用社區茶坊，把它升至ver 1.8

取消域名判斷

字數限制調高至800字元，算是big5版有簡體字時，一字會佔8字元...暈= =

刪除form標籤，不然按enter會跳到別頁 = =

2012年3月20日：
重寫zmc_chat.class.php判斷式，這樣只要檢查一次即可，才不會重覆run，算是在用社區茶坊v1.8另外想到

後台增設 版塊 內顯示位置設置，不用手動修改，方便些
0 不啟用不顯示
1 版規下方顯示
2 子版下方顯示
3 頁底顯示 
方便切換顯示位置

後台增設 論壇首頁顯示 是否要與獨立頁 共用同文件做記錄檔 ，是同用zchat.php，否則論壇頁用zforum.php，獨立頁用zchat.php

表情符號 刪除php變數調用，改用js外調方式 = =，這樣大約100張圖來說，可省去每次php載入近10kb ^^
調用方式原本是每次執行跑迴圈...暈，後改zadmin.php緩存zmcsmile.php每次載入= =，這次改成zadmin.php存成zmcsmile.js，
後用javascript載入，更有效率。

表情符號 圖片，抓x2的common和社區茶坊內的用用，還是用小張圖比較好，才不佔位，之前用洋蔥頭，一張圖佔3行，
不過洋蔥頭花樣比較多

fix 一些訊息順序相反 = =，之前是舊上新下，後改舊下新上...沒去修改到。

2012年3月21日：
javascript getMonth是由0算起，使用時要+1，之前沒看到今天才留意到少一個月 = =，已用好了。

2012年3月26日：
將$_G['cache']['plugin']['zmc_chat']插件變數陣列放至$zmcg01內，算是程式碼才不會落落長...看別人也這樣用，
一般變數用好是不太想改，避免那個地方沒覆蓋好又出錯= =

2012年3月29日：
zmcchat.php 內加入2符號 / ? 轉htm 16進位

2012年3月31日：
調整2處js
文字顏色，沒選則用dz x 預設普通字色(之前black為預設)，如果用話夾子工具選字色(則用此字色)
回傳的資料，如果沒內容，則不跑while那段代碼

去掉 zmcchat.php 內加入2符號 / ? 轉htm 16進位，想想不對，這2符號不能轉16進位...不然沒法發網址

2012年4月5日：
文字顏色及表情符號 的div改為，點一下後就隱藏。

2012年4月15日：
懶懶的又丟這好幾天不管，安裝說明也打好，準備要發文，但在測試時又發現問題= =，
ajax資料收發，是使用utf8，在utf8上是沒問題，但用gbk及big5就出問題，要做到精細處理又要好多行和不少判斷，
覺得好麻煩，算了...中文字用mb_convert_encoding全轉htm 十進位...一個字要用8位元存放= =，
最大字也改成1100，大約可留120中文字，應該夠用了。

2012年4月20日：
沒力...沒之前用社區茶坊那樣狂趴文，大約了解插件流程後，就沒動力了 = =，這話夾子搞好久了。

設置介面 變更-> 管理介面，加入可刪除 訊息 功能(單筆或多筆刪除)，
有不良聊天話題時，可單筆或多筆刪除，算是方便些，不用全刪。

返回上一頁 改為-> 返回首頁

調整存放記錄數至 50 ，算是改成htm 10進位存放中文字，多1倍以上容量，存放陣列數改小點比較好。

後台多加一個參數langadmin，管理介面簡繁切換用。

話夾子後台預設參數及說明調整。

2012年4月23日：

foreach內的if判斷加入break; ，之前沒注意，權限判斷是沒什麼差，大約跑1~3次迴圈
顯示版區多的話就有差一點點，比對到跳出迴圈才對。

zadmin.php 單筆或多筆 在全刪時，沒任何陣列時又出毛病，fix它，加入all data is deleted.

2012年5月15日：

zmcchat01.htm 及 zmcchat02.htm 修改如下：
輸入完 訊息後 按下enter鍵也可發送
調整部份變數位置
去掉 char 語系變數
文字顏色 改為 英文方式，省去語檔替換

zmcchat.php 也去掉 強制語系部份，已將中文字 轉為 htm 十進位


-------------- 2012年7月17日 ~ 2012年7月20日 ---------------

丟這不管好一陣子，搞完了 社區茶坊 ver 1.9 ，又來check check一下，這插件了...

名稱統一用 話匣子 ，之前忘了查到什麼用 話夾子 ，這2個也不知有何差別，麻煩...直接用 話匣子 好了。

社區話匣子部份代碼調整及測試，之前用X2，現在改用新版 discuz X2.5 20120701

fix ajax資料要求次數，算是之前用firebug時，發現少了一次，重新 check 迴圈及判斷 好幾次，才過2個月，差點看不懂在搞啥鬼東

document.getelementbyid 用 zdg 取代，不然代碼，落落長 ok

可瀏覽不能發言: 設置 7遊客 時，遊客在瀏覽時，目前只能查看一次內容，不會更新，算是社區茶坊有人反應，
後話匣子也改為還是會跑 ajax資料要求次數，跑完所設定次數後 顯示 離線重線 按鈕，按一下後就會重新 run ajax

zmcchat.php 將htmlspecialchars用自建zhtmrep取代

zmcchat.php 字元數判斷調整

中文轉換是用 mb_convert_encoding 如沒支援改用iconv轉，大部份webhost都有支援mb_convert_encoding及iconv，
php5.4.x也內建 mb_convert_encoding ，不過全面改用php5.4.x，大約還要2~3年吧，改了不少東西的樣子
zmcchat.php 方式是全轉 htm 十進位，缺點是一個中文字要吃 8 byte = =，好處是不會有缺字問題，也不用做什麼字符集判斷，問題少。
不過一個中文字吃到 8 byte，實在有點肥，總之先用一陣子看看，未來在看情形成 utf8轉簡 或 utf8轉繁 = =

zmcchat.php 開頭加入 no-cache 不要緩存

去掉 post 傳送 ./zforum.php ./fidxx.php 中的 ./及.php 改只傳 zforum fidxx

增加個 各記錄檔t.php，用來存放各記錄檔最後更新時間，這樣讀入時先比對此檔內的時間，
如果最後更新時間一樣，則不載入記錄檔，比較有效率，畢竟讀取比寫入要多上數倍

記錄檔共用開關 沒啥用，去掉，未來獨立頁，有時間在另行開發 = =

訊息輸入框長度，後台增加一個變數設置，方便風格調整，如沒右邊欄，可設長一點，如有右邊欄就設短一些。

去掉最底下管理介面語系設置參數，改由對應語言檔名稱來判斷管理介面是簡或繁

aaa >> 對 bbb 說： 改為 aaa >> to bbb say:
圖片的 點擊圖片,可至對應網址查看全圖 改為 Click this image that view full it.
有單引號的行，不想有變數取代，刪了 對 說：及圖片title -> 3個lang替換。

$_G[sid] 取代 zmcchat.php 內 session_start 那3段的調用，抓前3字元做同秒 check 用
後到class.php及inc.php 後至 zmcchat02.htm 模版上，用了好久...，最後放棄此法，未來在考慮用看看，
跨頁又要不少check，麻煩 = =

zmcchat01.htm 獨立頁顯示用模板 copy zmcchat02.htm 後修改小部份，更新 ok

readmebig5.txt及readmegbk.txt 安裝使用，加入參數設置說明，方便大家明白。

大致完成後，試了免空，VP和000webhost沒什麼問題，德國kilu掛掉沒法試，後到西班牙免空...訊息送出後沒法記錄，
它這是沒支援mb_convert_encoding，但有支援iconv，但是用mb_等東西轉10進位，後找到是mb_strlen它不能用...
猜精mb_相關組件都沒裝，那麼用iconv轉10進位，就沒義意了
改用傳字符集方式，utf8版就不轉換，big5及gbk在mb_convert_encoding轉換，如沒支援則在用iconv轉
缺點是mb_convert_encoding及iconv會有漏字問題，由其big5更是嚴重，GBK似乎都沒問題，
搞了好幾小時，查了不少資料，最後用了1個function，功能等同mb_convert_encoding轉HTML-ENTITIES，轉成網頁十進位。
iconv沒有轉htm十進位功能，之前找了一個，結果它要mb_strlen...mb_系列中的convert都不支援，用了沒意義，現在
 
tcutf8 scutf8 就是用utf8版的 x1.5,x2,x2.5 不做字符轉換  
gbk big5 用簡體版及繁體版的 x1.5,x2,x2.5 做字符轉換，中文字部份用mb_convert_encoding轉HTML-ENTITIES，
如果主機不支援mb_convert_encoding，則跑自制function來轉。

這要命的問題，前後不知改了多少次...先暫時這樣處理。

由於西班牙免空沒mb_convert_encoding，跑ztoh轉換，結果我打了 ： ， 、 這些全形字，全不見了 = =，
查了1~2小時，才找到原因，原來是判斷unicode第2 3 4字元，少算1個字數...改過後就好了，
好加在，我對這不熟，還好不是什麼大問題。

由於沒動到 安裝用xml，就懶的 update 什麼版本，改那很麻煩，檔案由 zmcchatv11.zip 改為 zmcchatv11a.php 

版本變更為 Ver 1.1

---------------- 2012年7月20日 ~ 2012年7月22日 -------------------------------

又想到一個idea，算是一個裝 社區話匣子 動漫論壇，有時連過去偷看一下，它右下又裝那個浮動好友什麼來的我不清楚，
後來又移除掉，這時該論壇某會員，說了什麼不好解決，忘了，我想應該是指一對一之類的功能。

話匣子也是有那功能，但是公開非隱藏，後來想到，可能可以用js做判斷，不過要改不少地方 -,-
如果[To] idname [Say]的對像是自已，則可見，不是則顯示 ＊＊＊ 悄 悄 話 ＊＊＊
＊＊＊ <- 要用 htm 10進位，悄悄 這2字簡繁體一樣 也用 htm 10進位， 話 不同則用到lang檔內。

遊客不能點任何人，會員不能點自已

A 對 B 悄悄話時，只有 A 和 B 可見內容，其它人只見 ~ ~ ~ 悄 悄 話 ~ ~ ~

js 顯示訊息 表情及IMG 調整替換正則，及用成function調用

送出及接收訊息各一處，重覆性代碼改為一次

悄悄說訊息框前 加入 按此取消

img 連續2張或以上報錯，還有忘了https這種，有個s的，fix it

反斜線問題...就是怕有人用這為名稱，這東西非常不好處理，
有的主機有開自動加\有的主機沒開啟，除了加還有個減就是2個\取代成1個一樣有的有開有的沒開，
而且x2和x2.5又不同好像x2.5不在自動加\，應該是配合新版php吧，php5.4開始不強制加\，新舊版問題...天阿。
UTF-8和GBK比較OK沒有中文字後面帶92的，好處理，BIG5就要命了，死BIG5 ...= =
反斜線搞了我好多小時，最後 UTF-8及GBK 直接取代為空，省去一堆煩人問題，避免\結尾搞到整個網頁掛了
BIG5則是連續\\取代為\及最後一字元判斷為\，則用一個全形空白取代，一樣避免\結尾搞到整個網頁掛了
\大約簡單處理一下
回想起之前版本是將只要有 ' " \ 全數轉 * 號，是測big5版時，只要中文字尾有92就變 ? 才開始在處理。
大致完工，又測試了一下，又出現 ' 造成 js 點 對像無反應，算了...麻煩死了 這3個及<>全替換為 空，
而BIG5則2個反斜替換成1個，其它 ' " <> 一樣也替換成 空，總之功能先正常能用為先...暫時這樣處理。

版本變更為 Ver 1.2

-----------------------------------------------

2012年7月23日：
http://taiwan2.uk.to/u2/ 此展示站C，域名老出問題，於是重裝X2.5，後表情改用洋蔥頭，結果點重建...空白，
連想都不用想，是寫入權限問題，刪除zmcsmile.js後，給php重建就ok了，當然也可將zmcsmile.js設 777 ，
在readmebig5.txt及readmegbk.txt，後面表情重建教學，補上注意檔案權限問題。


2012年7月24日：
這串改為只限管理組權限才看的見
zdg("showword02").innerHTML = "There was a problem with the request.<br>" + zdg("showword02").innerHTML;

有時客戶端，網路不良...如邊下載邊瀏覽，造成塞車，而使 ajax 狀態值得不到4及200這2個正常值，
就一直報那串...造成洗頻 = = ...唉，一堆這種人。

本打算刪掉那串，但如果出現主機端不正常時(通常機會不多)，可方便管理員查看主機是否正常，
所以改成管理組權限才看的見。

只做了這小修正，懶的更新版本，改為 zmcchatv12b.zip

------------------------------------------------

最後想想最是刪除掉好了
else{
<!--{if $checkboss01 == 1}-->
         zdg("showword02").innerHTML = "There was a problem with the request.<br>" + zdg("showword02").innerHTML;
<!--{/if}-->
}
反正能連就是能看見訊息，不能連就是空白，那一串警告，意義不大。

檔案改為 zmcchatv12c.zip





...待調整及完成事項，先記錄：

按鈕全統為22高度，並全部改由 js 的.style做給值，可省去數個同變數替換

輸入框，打完字後，按下 enter 在IEtest下無效，但另4種瀏覽器可行，試一下其它方式

字的顏色選擇，沒選時 undefined 是用這字串，太長了，改 noc 3字元就好，這樣記錄檔可省些位元，下版在用

獨立顯示頁，左邊或右邊加入在線名單，由於是獨立頁用個在線名單，是沒什麼差，論壇首頁及版區的話就很吃重，外加佔版面
在線名單可做成另一隻php獨立運行，小記一下。

css 調用方式待優化，反正已採用 ajax 方式，不像社區茶坊那樣一直刷網頁，css直接嵌在頁面裡，也是沒什麼差

簡體GBK用戶，在記錄存放上也同BIG5那樣，轉為 htm 十進位，在考慮要不要改成
mb_convert_encoding($zconv01,'GBK','UTF-8');
沒支援mb_組件時，才跑 htm 十進位，對GBK不熟，查了些資料好像處理的很好，
UTF-8轉GBK沒有漏字問題 ... 真麻煩，到底要不要改這樣，下版在想這事 = =


ver 1.2 增強悄悄話，所帶來的另外問題：
悄悄話,要不要將 對像 [To]name[/Say] 改成網頁另外傳值，但如果沒悄悄話每次寫入記錄格式會多一個 |，可是這樣方便日後開發...

遊客不能點會員，但會員可點遊客，這會造成所有遊客可見該會員對遊客說的話，應該是會員也不能點遊客，
只要不開放遊客發言就沒這問題，本身開發遊客發言，管理就很累人...這問題，處理麻煩暫不處理。

A 對 B ~ ~ ~ 悄 悄 話 ~ ~ ~ ，就是A對B悄悄話，會顯示出來，原則上是不用顯示這段，暫時做成顯示 悄悄話

悄悄話內容，是否改成 系統用戶組 ，所設定的組別可見...先觀察一陣子，整理上沒問題在改

如果非UTF-8版，也就是使用GBK及BIG5版用戶，在記錄上是轉 htm 十進位來存放， 
在接收訊息上，[To]中文名稱[/Say]，則會被轉10進位...目前處理是JS 加了 convtohtm 將自已名稱轉 10進位，做比對是否一樣，
但怕各家瀏覽器支援問題... 這問題，等有人回報在看如何辦好了 ... 麻煩



.


自我提醒用：
如有動到或修改到安裝用xml，用ConvertZ轉換完gbk big5 utf8後，要用編輯器，修改各xml內對應語系檔，

及 Data 下的 version 要改 X1.5,X2,X2.5 安裝才不會報版本相容 (非 root 或 plugin 開頭下的 version )
















.