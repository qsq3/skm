.

Discuz X1.5 X2 X2.5 简易 Ajax 聊天室插件 (社区话匣子) 无需 mysql
原创作者：zmarkchang、markchang、warkinger
问题回报网址：http://blog.sina.com.cn/s/blog_a379ef0401013xag.html


-----Discuz!应用中心自动下载,安装说明-----------------------------------------------------------------------------

/source/plugin/zmc_chat/ 

zmc_chat 该目录，用来存取各记录档及表情符号缓存，大部份不设 777 应该也行，不过设 777 是比较好，

安装后，如果无法存取讯息时，请用FTP将 /source/plugin/zmc_chat/ 之 zmc_chat 目录设 777

设置参考图片连结：http://img.ly/gaRr/ 及 http://img.ly/gaRw/

备站(图一)：https://picasaweb.google.com/lh/photo/9zZUPrhVr0Er4Gq77-qD6dMTjNZETYmyPJy0liipFm0
备站(图二)：https://picasaweb.google.com/lh/photo/kRRS9qBAbiX5tODXrus6-tMTjNZETYmyPJy0liipFm0

后台 -> 插件 -> 安装新插件 -> 选zmc_chat -> 安装 -> 选择论坛语系(简体 简utf8 繁体 繁utf8) -> 启用

后台 -> 工具 -> 更新缓存


-----自行上传zmc_chat目录,安装说明---------------------------------------------------------------------------------

zmcchatv12c.zip 解压后，里面会有个目录 zmc_chat (名称不可改变)，

将此 zmc_chat 目录含里面的东西，全数上传至 /source/plugin/ 插件目录下。

/source/plugin/zmc_chat/ 

zmc_chat 该目录，用来存取各记录档及表情符号缓存，大部份不设 777 应该也行，不过设 777 是比较好，

安装后，如果无法存取讯息时，请用FTP将 /source/plugin/zmc_chat/ 之 zmc_chat 目录设 777

设置参考图片连结：http://img.ly/gaRr/ 及 http://img.ly/gaRw/

备站(图一)：https://picasaweb.google.com/lh/photo/9zZUPrhVr0Er4Gq77-qD6dMTjNZETYmyPJy0liipFm0
备站(图二)：https://picasaweb.google.com/lh/photo/kRRS9qBAbiX5tODXrus6-tMTjNZETYmyPJy0liipFm0

后台 -> 插件 -> 安装新插件 -> 选zmc_chat -> 安装 -> 选择论坛语系(简体 简utf8 繁体 繁utf8) -> 启用

后台 -> 工具 -> 更新缓存


-----Ajax传输及接收,优化解说-----------------------------------------------------------------------

缓存多少笔记录: 40
数据抓取间隔: 15
多少次判离线: 40
防灌水间隔: 5

这4个参数，互相之间都有微妙的影响，与其它参数设置不太同，需要长时间的观察，请各位站长留意一下。
例如：
数据抓取间隔: 15
缓存多少笔记录: 40
防灌水间隔: 5

意思是15秒内，记录40笔数据，假设15秒内，来了50笔数据，那么前10笔数据，将会丢失掉，

这时可加长，防灌水间隔，该如何说，防灌水已经设5秒了，15秒内又超过40笔，代表你网站满热闹，主机压力应该不小，

所以优先加长，防灌水间隔: 10~60 ，次才是选择加大，缓存多少笔记录: 50~80 ，最后才是缩短，数据抓取间隔: 10~15 ，

至于，多少次判离线，这比较好理解，就是 数据抓取间隔*多少次判离线 15秒 * 40次 = 600秒，后除60，得 10 分钟，

也就是挂住 10分钟，不发话就被判中离，不在传送数据，当然按钮会变 离线重连 ，在按一下，又可挂住 10 分钟。

.

忘了说，只要发话(送出讯息)，抓取次数会重新计算，意思是10分钟内，只要发话一次，需再过10分钟后，才会被判中离，

另外，发话(送出讯息)后，会即时得到最新讯息，不须再等间隔秒数。

.

如果觉得抓取间隔15秒太长，老子的付费主机 涷的住 耐操有档头，那么可先设置：

缓存多少笔记录: 30
数据抓取间隔: 10
多少次判离线: 120
防灌水间隔: 5

10秒内，如果发话数超过30笔，则缓存多少笔记录在改40，在超过则在加个10笔改50，

缓存多少笔记录，愈少，主机端处理愈快，但不能太少，会丢话，要配合数据抓取间隔和防灌水设置。

上述设置中，数据抓取间隔 * 多少次判离线，为 10 * 120 = 1200秒，后除 60秒 = 20分钟，意思是挂网20分钟才会被判中离。

多少次判离线，也不用设太长，反正可按重连，一般10~15分钟应该可以，有的5分钟没说话就算中离。

.

这不像社区茶坊那样，2~3分钟不停重刷架框内的网页，由其是满80条记录，都上百kb在那不停刷阿刷的，

是说现在付费webhost大部份都无限流量，或很大流量，用不完，没什么差就是了。

社区话匣子用 Ajax 只会更新讯息部份，效率上是比较好。

显示讯息，不会像社区茶坊那样，永远是80条(预设80)，Ajax会不断的把新讯息加在最前面，

如果热闹有不少发话，挂个30分钟，应该有上百条讯息，在不重新整理页面或重进该页时，

这些讯息就可以慢慢观看，因此 缓存多少笔记录: 设个30~50笔 就可以，配合抓取间隔及加长防灌水秒数，

只要设置到不丢话就行，这方面就需要站长，观察自已站上发话数量来设置了。


像某个知名直播大站，有不少直播台都上千人在观看，它们的管理员都会把发话间隔设60秒或120秒，就是防灌水设 60 ~ 120秒。


算是之前用了社区茶坊很长一段时间，至DZ X2才将社区茶坊升级，那时有人建议能否改成Ajax，

后随便在网路上，找了个Ajax精简聊天室，在分解它，拿来改成这个社区话匣子。

社区茶坊，在设置上就80条记录3分钟刷一次，不用管它什么优化不优化，也优化不了，一次都上百kb在刷流量 = =，

用了这个Ajax才大约了解，要留意 抓取间隔、存放多少笔、抓几次不给抓、防灌水，这些设置之间的微妙关系，

大致上先用预设，以不丢话为前提，看发话量在慢慢调整即可。


解说有点长，如果不太熟，请多看几次，久了就明白了。

.

-----浏览权限设置说明-------------------------------------------------------------------------------

由于是采用户组判断，依全新 Discuz X2 预设 系统用户组，
如你有变更请调整 (可浏览不能发言 不可浏览及发言 管理用户组) 这3项。

后台 -> 用户 -> 用户组 -> 系统用户组 ，查看 (groupid: 数字)

.

游客(访客)设置 (采用户组比对) ，DZ X2 游客 预设是 7

游客(访客) 可浏览可发言 设置方案 (将 7 去掉就行) ：
可浏览不能发言： 4,8
不可浏览及发言： 5,6
话匣子管理组:    1,2

游客(访客) 可浏览不可发言 设置方案：
可浏览不能发言： 4,8,7
不可浏览及发言： 5,6
话匣子管理组:    1,2

游客(访客) 不可浏览不可发言 设置方案： ( 推荐，尽量不要开放游客浏览及发言，比较好 )
可浏览不能发言： 4,8
不可浏览及发言： 5,6,7
话匣子管理组:    1,2



-----社区话匣子,论坛首页显示,顺序调整,导航栏显示设置说明-------------------------------------------

论坛首页显示顺序调整：

社区话匣子 是放在 插件 列表内，如没显示，后台 -> 工具 -> 更新缓存

安装后除了在插件列表内，也会显示在forum论坛首页，有3个位置可变更也可不显示 ( 自行调整话匣子forum显示位置 )

如果你想改放在KK_XSHOW之类的首页四格下方，后台 -> 插件 -> 社区话匣子 -> 设置 -> forum显示位置: 1

后调整显示顺序，插件 -> 插件列表 -> 右边显示顺序： 首页四格设1，社区话匣子设2 -> 提交


插件顺序调整：

后台 -> 界面 -> 导航设置 -> 主导航 -> 插件左边 [+] 点下去，显示顺序 (依数字排序调整) -> 提交


导航栏显示设置：

如果想在主导航栏，也显示社区话匣子，设置方式：
后台 -> 界面 -> 导航设置 -> 主导航 -> 下方有个添加主导航 -> 
顺序(自已调整) 
名称输入 聊天室 或 闲聊 或 谈天 或 茶坊 ...等，不宜太长2~3字就好
连结输入 plugin.php?id=zmc_chat:zmc_chat

参考图片连结：http://img.ly/kX9t/ 及 http://img.ly/kX9A/

备站(图一)：https://picasaweb.google.com/lh/photo/ibPGpLfr-koDBSx3kkvK09MTjNZETYmyPJy0liipFm0?feat=directlink
备站(图二)：https://picasaweb.google.com/lh/photo/cpZ1RAUme9geYeUG2K_GWtMTjNZETYmyPJy0liipFm0?feat=directlink



-----社区话匣子,版块显示设置说明-------------------------------------------------------------------

后台 -> 论坛 ，假设你现在有如下讨论版：

新手报到 fid:2
杂话闲聊 fid:5
动漫讨论 fid:30
游戏讨论 fid:37
版主讨论 fid:48

后上述5个版块内，你都想显示话匣子，则下述设置后提交

后台 -> 插件 -> 社区话匣子 -> 设置 -> 要显示的版块:
2,5,30,37,48

后台 -> 插件 -> 社区话匣子 -> 设置 -> 版块内的位置:
1

参考图片连结：http://img.ly/h6XI/

图片备站：https://picasaweb.google.com/lh/photo/Cmbtyldgdwy0VFmdot6gSdMTjNZETYmyPJy0liipFm0


.

如果论坛首页的东西已经很多了，论坛首页则可考虑关闭话匣子显示，而设某个版区显示话匣子，
如：闲聊区、新手报到区 之类，或 导航栏 论坛或记录的右边在增加个 聊天室 选项，设置方式请参考上述2教学。

如像 版主讨论区 可先设成私密，限版主以上权限才能进入，后在此版设个 话匣子，有时比起发贴，这样算方便不少。 

.


-------讯息输入框长度设置说明---------------------------------------------------------------------

讯息框长度:

Ver 1.1 后台增加，讯息输入框长度设置，方便有的右边开侧栏，或版区左边侧栏，或窄风格，可调整输入框长度。

讯息输入框长一点是比较好，但不可设的太长，避免工具及发话钮走位，只要设到那2个按钮不跑位就行，

设完后，记得用多种浏览器检查看看，各家浏览器许多内定数值都有差异，如 IE 输入框设个100应该刚刚好，

但用 F 或 c 或 O 的浏览器可能就会发生走位，所以不要设的刚刚好，最好少个 10~15 。

另外，讯息输入框，输入完讯息后，按 Enter 键，也可发话，在此补充说明这点 ^^



-----表情符号变更方式说明-------------------------------------------------------------------------

前台 -> 工具 -> 设置介面 -> 重建表情符号

会扫瞄 /source/plugin/zmc_chat/zsmile/ 目录内 .gif .png .jpg 并缓存成zmcsmile.js

另外需留意：表情符号不宜太多，尽量在 100 个以内，不然zmcsmile.js这档会很大，影响速度。

.

大约流程：
洋葱头表情备站下载：https://skydrive.live.com/?cid=fc208de42ae3e348&id=FC208DE42AE3E348%21446
洋葱头表情备站下载：https://www.asuswebstorage.com/navigate/s?u=GYYUJYA5NY

用FTP先将 /source/plugin/zmc_chat/zsmile/ 目录内的所有档案删除，

因为每种表情符号，高和宽都不同，尽量用一样的高宽，排列比较美观，

另一原因是表情档尽量在 100 个以内，避免zmcsmile.js档过大，影响速度。

在将 smilezse01.zip 解压后，该目录内所有档案上传至 /source/plugin/zmc_chat/zsmile/ 目录下，

前台 -> 工具 -> 设置介面 -> 重建表情符号 (打勾后,点确定执行) -> 确定，

在看看话匣子里的 工具 -> 表情符号 ，看有没有改变，如没改变可用浏览器 -> 重新整理 (按 F5 键也是重新刷新)

PS:
点重建表情按钮后，出现空白...这是zmcsmile.js档案无法写入，用FTP将下述文件设 777

/source/plugin/zmc_chat/zmcsmile.js

或是将zmcsmile.js删除，在点重建表情一次即可。

因为有的主机，FTP上传与php建立，所设的权限不同的话，此时删除zmcsmile.js给php重建，或是将zmcsmile.js此档设 777 都行。


--------错误讯息说明--------------------------------------------------------------------------------

There was a problem with the request. 
这串已由zmcchatv12c.zip开始，删除掉了，如果一直收不到讯息，原因如下：

1.客户端，网路不良，如：边下载边浏览...造成网路塞车，ajax 得不到4及200这2个状态值，大部份都网路不良，得不到讯息。

2.主机端出问题送不出讯息

3.域名无法对应，DNS解析出问题，Ajax规定收发要同域名

4.档案写入权限问题，测试约4个空间，大致上都不用将 zmc_chat 设成777 都可正常运作，
如果按送出讯息后，没任何回传，一片空白，应该也是记录档无法写入造成，
先将zmc_chat目录设777及该目录内的记录档也设成777

zchat.php 及 chatt.php 插件独立页
zforum.php 及 zforumt.php 论坛首页

如果你有开启版区显示话匣子功能时，下述档名中的数字是代表各版的 fid

fid数字.php 及 fid数字t.php

每个版区用来存放记录的档案，是各自分开成，将这些也设 777 比较好。




上述安装及使用说明，最后更新日期： 2012年7月24日
----------------------------------------------------





Ver 1.2，修改了不少地方，已用四种浏览器反覆测试n次，

不知还有无bug，如有发现可至下述论坛寄短讯：

http://www.discuz.net/  寄短讯给 warkinger
http://www.alan888.com/ 寄短讯给 warkinger

或至下述新浪网址回报：
http://blog.sina.com.cn/s/blog_a379ef0401013xag.html






















.