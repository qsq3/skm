.

Discuz X1.5 X2 X2.5 簡易 Ajax 聊天室插件 (社區話匣子) 無需 mysql
原創作者：zmarkchang、markchang、warkinger
問題回報網址：http://blog.sina.com.cn/s/blog_a379ef0401013xag.html


-----Discuz!應用中心自動下載,安裝說明-----------------------------------------------------------------------------

/source/plugin/zmc_chat/ 

zmc_chat 該目錄，用來存取各記錄檔及表情符號緩存，大部份不設 777 應該也行，不過設 777 是比較好，

安裝後，如果無法存取訊息時，請用FTP將 /source/plugin/zmc_chat/ 之 zmc_chat 目錄設 777

設置參考圖片連結：http://img.ly/gaRr/ 及 http://img.ly/gaRw/

備站(圖一)：https://picasaweb.google.com/lh/photo/9zZUPrhVr0Er4Gq77-qD6dMTjNZETYmyPJy0liipFm0
備站(圖二)：https://picasaweb.google.com/lh/photo/kRRS9qBAbiX5tODXrus6-tMTjNZETYmyPJy0liipFm0

後台 -> 插件 -> 安裝新插件 -> 選zmc_chat -> 安裝 -> 選擇論壇語系(簡體 簡utf8 繁體 繁utf8) -> 啟用

後台 -> 工具 -> 更新緩存


-----自行上傳zmc_chat目錄,安裝說明---------------------------------------------------------------------------------

zmcchatv12c.zip 解壓後，裡面會有個目錄 zmc_chat (名稱不可改變)，

將此 zmc_chat 目錄含裡面的東西，全數上傳至 /source/plugin/ 插件目錄下。

/source/plugin/zmc_chat/ 

zmc_chat 該目錄，用來存取各記錄檔及表情符號緩存，大部份不設 777 應該也行，不過設 777 是比較好，

安裝後，如果無法存取訊息時，請用FTP將 /source/plugin/zmc_chat/ 之 zmc_chat 目錄設 777

設置參考圖片連結：http://img.ly/gaRr/ 及 http://img.ly/gaRw/

備站(圖一)：https://picasaweb.google.com/lh/photo/9zZUPrhVr0Er4Gq77-qD6dMTjNZETYmyPJy0liipFm0
備站(圖二)：https://picasaweb.google.com/lh/photo/kRRS9qBAbiX5tODXrus6-tMTjNZETYmyPJy0liipFm0

後台 -> 插件 -> 安裝新插件 -> 選zmc_chat -> 安裝 -> 選擇論壇語系(簡體 簡utf8 繁體 繁utf8) -> 啟用

後台 -> 工具 -> 更新緩存


-----Ajax傳輸及接收,優化解說-----------------------------------------------------------------------

緩存多少筆記錄: 40
數據抓取間隔: 15
多少次判離線: 40
防灌水間隔: 5

這4個參數，互相之間都有微妙的影響，與其它參數設置不太同，需要長時間的觀察，請各位站長留意一下。
例如：
數據抓取間隔: 15
緩存多少筆記錄: 40
防灌水間隔: 5

意思是15秒內，記錄40筆數據，假設15秒內，來了50筆數據，那麼前10筆數據，將會丟失掉，

這時可加長，防灌水間隔，該如何說，防灌水已經設5秒了，15秒內又超過40筆，代表你網站滿熱鬧，主機壓力應該不小，

所以優先加長，防灌水間隔: 10~60 ，次才是選擇加大，緩存多少筆記錄: 50~80 ，最後才是縮短，數據抓取間隔: 10~15 ，

至於，多少次判離線，這比較好理解，就是 數據抓取間隔*多少次判離線 15秒 * 40次 = 600秒，後除60，得 10 分鐘，

也就是掛住 10分鐘，不發話就被判中離，不在傳送數據，當然按鈕會變 離線重連 ，在按一下，又可掛住 10 分鐘。

.

忘了說，只要發話(送出訊息)，抓取次數會重新計算，意思是10分鐘內，只要發話一次，需再過10分鐘後，才會被判中離，

另外，發話(送出訊息)後，會即時得到最新訊息，不須再等間隔秒數。

.

如果覺得抓取間隔15秒太長，老子的付費主機 涷的住 耐操有檔頭，那麼可先設置：

緩存多少筆記錄: 30
數據抓取間隔: 10
多少次判離線: 120
防灌水間隔: 5

10秒內，如果發話數超過30筆，則緩存多少筆記錄在改40，在超過則在加個10筆改50，

緩存多少筆記錄，愈少，主機端處理愈快，但不能太少，會丟話，要配合數據抓取間隔和防灌水設置。

上述設置中，數據抓取間隔 * 多少次判離線，為 10 * 120 = 1200秒，後除 60秒 = 20分鐘，意思是掛網20分鐘才會被判中離。

多少次判離線，也不用設太長，反正可按重連，一般10~15分鐘應該可以，有的5分鐘沒說話就算中離。

.

這不像社區茶坊那樣，2~3分鐘不停重刷架框內的網頁，由其是滿80條記錄，都上百kb在那不停刷阿刷的，

是說現在付費webhost大部份都無限流量，或很大流量，用不完，沒什麼差就是了。

社區話匣子用 Ajax 只會更新訊息部份，效率上是比較好。

顯示訊息，不會像社區茶坊那樣，永遠是80條(預設80)，Ajax會不斷的把新訊息加在最前面，

如果熱鬧有不少發話，掛個30分鐘，應該有上百條訊息，在不重新整理頁面或重進該頁時，

這些訊息就可以慢慢觀看，因此 緩存多少筆記錄: 設個30~50筆 就可以，配合抓取間隔及加長防灌水秒數，

只要設置到不丟話就行，這方面就需要站長，觀察自已站上發話數量來設置了。


像某個知名直播大站，有不少直播台都上千人在觀看，它們的管理員都會把發話間隔設60秒或120秒，就是防灌水設 60 ~ 120秒。


算是之前用了社區茶坊很長一段時間，至DZ X2才將社區茶坊升級，那時有人建議能否改成Ajax，

後隨便在網路上，找了個Ajax精簡聊天室，在分解它，拿來改成這個社區話匣子。

社區茶坊，在設置上就80條記錄3分鐘刷一次，不用管它什麼優化不優化，也優化不了，一次都上百kb在刷流量 = =，

用了這個Ajax才大約了解，要留意 抓取間隔、存放多少筆、抓幾次不給抓、防灌水，這些設置之間的微妙關係，

大致上先用預設，以不丟話為前提，看發話量在慢慢調整即可。


解說有點長，如果不太熟，請多看幾次，久了就明白了。

.

-----瀏覽權限設置說明-------------------------------------------------------------------------------

由於是採用戶組判斷，依全新 Discuz X2 預設 系統用戶組，
如你有變更請調整 (可瀏覽不能發言 不可瀏覽及發言 管理用戶組) 這3項。

後台 -> 用戶 -> 用戶組 -> 系統用戶組 ，查看 (groupid: 數字)

.

遊客(訪客)設置 (採用戶組比對) ，DZ X2 遊客 預設是 7

遊客(訪客) 可瀏覽可發言 設置方案 (將 7 去掉就行) ：
可瀏覽不能發言： 4,8
不可瀏覽及發言： 5,6
話匣子管理組:    1,2

遊客(訪客) 可瀏覽不可發言 設置方案：
可瀏覽不能發言： 4,8,7
不可瀏覽及發言： 5,6
話匣子管理組:    1,2

遊客(訪客) 不可瀏覽不可發言 設置方案： ( 推薦，盡量不要開放遊客瀏覽及發言，比較好 )
可瀏覽不能發言： 4,8
不可瀏覽及發言： 5,6,7
話匣子管理組:    1,2



-----社區話匣子,論壇首頁顯示,順序調整,導航欄顯示設置說明-------------------------------------------

論壇首頁顯示順序調整：

社區話匣子 是放在 插件 列表內，如沒顯示，後台 -> 工具 -> 更新緩存

安裝後除了在插件列表內，也會顯示在forum論壇首頁，有3個位置可變更也可不顯示 ( 自行調整話匣子forum顯示位置 )

如果你想改放在KK_XSHOW之類的首頁四格下方，後台 -> 插件 -> 社區話匣子 -> 設置 -> forum顯示位置: 1

後調整顯示順序，插件 -> 插件列表 -> 右邊顯示順序： 首頁四格設1，社區話匣子設2 -> 提交


插件順序調整：

後台 -> 界面 -> 導航設置 -> 主導航 -> 插件左邊 [+] 點下去，顯示順序 (依數字排序調整) -> 提交


導航欄顯示設置：

如果想在主導航欄，也顯示社區話匣子，設置方式：
後台 -> 界面 -> 導航設置 -> 主導航 -> 下方有個添加主導航 -> 
順序(自已調整) 
名稱輸入 聊天室 或 閒聊 或 談天 或 茶坊 ...等，不宜太長2~3字就好
連結輸入 plugin.php?id=zmc_chat:zmc_chat

參考圖片連結：http://img.ly/kX9t/ 及 http://img.ly/kX9A/

備站(圖一)：https://picasaweb.google.com/lh/photo/ibPGpLfr-koDBSx3kkvK09MTjNZETYmyPJy0liipFm0?feat=directlink
備站(圖二)：https://picasaweb.google.com/lh/photo/cpZ1RAUme9geYeUG2K_GWtMTjNZETYmyPJy0liipFm0?feat=directlink



-----社區話匣子,版塊顯示設置說明-------------------------------------------------------------------

後台 -> 論壇 ，假設你現在有如下討論版：

新手報到 fid:2
雜話閒聊 fid:5
動漫討論 fid:30
遊戲討論 fid:37
版主討論 fid:48

後上述5個版塊內，你都想顯示話匣子，則下述設置後提交

後台 -> 插件 -> 社區話匣子 -> 設置 -> 要顯示的版塊:
2,5,30,37,48

後台 -> 插件 -> 社區話匣子 -> 設置 -> 版塊內的位置:
1

參考圖片連結：http://img.ly/h6XI/

圖片備站：https://picasaweb.google.com/lh/photo/Cmbtyldgdwy0VFmdot6gSdMTjNZETYmyPJy0liipFm0


.

如果論壇首頁的東西已經很多了，論壇首頁則可考慮關閉話匣子顯示，而設某個版區顯示話匣子，
如：閒聊區、新手報到區 之類，或 導航欄 論壇或記錄的右邊在增加個 聊天室 選項，設置方式請參考上述2教學。

如像 版主討論區 可先設成私密，限版主以上權限才能進入，後在此版設個 話匣子，有時比起發貼，這樣算方便不少。 

.


-------訊息輸入框長度設置說明---------------------------------------------------------------------

訊息框長度:

Ver 1.1 後台增加，訊息輸入框長度設置，方便有的右邊開側欄，或版區左邊側欄，或窄風格，可調整輸入框長度。

訊息輸入框長一點是比較好，但不可設的太長，避免工具及發話鈕走位，只要設到那2個按鈕不跑位就行，

設完後，記得用多種瀏覽器檢查看看，各家瀏覽器許多內定數值都有差異，如 IE 輸入框設個100應該剛剛好，

但用 F 或 c 或 O 的瀏覽器可能就會發生走位，所以不要設的剛剛好，最好少個 10~15 。

另外，訊息輸入框，輸入完訊息後，按 Enter 鍵，也可發話，在此補充說明這點 ^^



-----表情符號變更方式說明-------------------------------------------------------------------------

前台 -> 工具 -> 設置介面 -> 重建表情符號

會掃瞄 /source/plugin/zmc_chat/zsmile/ 目錄內 .gif .png .jpg 並緩存成zmcsmile.js

另外需留意：表情符號不宜太多，盡量在 100 個以內，不然zmcsmile.js這檔會很大，影響速度。

.

大約流程：
洋蔥頭表情備站下載：https://skydrive.live.com/?cid=fc208de42ae3e348&id=FC208DE42AE3E348%21446
洋蔥頭表情備站下載：https://www.asuswebstorage.com/navigate/s?u=GYYUJYA5NY

用FTP先將 /source/plugin/zmc_chat/zsmile/ 目錄內的所有檔案刪除，

因為每種表情符號，高和寬都不同，盡量用一樣的高寬，排列比較美觀，

另一原因是表情檔盡量在 100 個以內，避免zmcsmile.js檔過大，影響速度。

在將 smilezse01.zip 解壓後，該目錄內所有檔案上傳至 /source/plugin/zmc_chat/zsmile/ 目錄下，

前台 -> 工具 -> 設置介面 -> 重建表情符號 (打勾後,點確定執行) -> 確定，

在看看話匣子裡的 工具 -> 表情符號 ，看有沒有改變，如沒改變可用瀏覽器 -> 重新整理 (按 F5 鍵也是重新刷新)

PS:
點重建表情按鈕後，出現空白...這是zmcsmile.js檔案無法寫入，用FTP將下述文件設 777

/source/plugin/zmc_chat/zmcsmile.js

或是將zmcsmile.js刪除，在點重建表情一次即可。

因為有的主機，FTP上傳與php建立，所設的權限不同的話，此時刪除zmcsmile.js給php重建，或是將zmcsmile.js此檔設 777 都行。


--------錯誤訊息說明--------------------------------------------------------------------------------

There was a problem with the request. 
這串已由zmcchatv12c.zip開始，刪除掉了，如果一直收不到訊息，原因如下：

1.客戶端，網路不良，如：邊下載邊瀏覽...造成網路塞車，ajax 得不到4及200這2個狀態值，大部份都網路不良，得不到訊息。

2.主機端出問題送不出訊息

3.域名無法對應，DNS解析出問題，Ajax規定收發要同域名

4.檔案寫入權限問題，測試約4個空間，大致上都不用將 zmc_chat 設成777 都可正常運作，
如果按送出訊息後，沒任何回傳，一片空白，應該也是記錄檔無法寫入造成，
先將zmc_chat目錄設777及該目錄內的記錄檔也設成777

zchat.php 及 chatt.php 插件獨立頁
zforum.php 及 zforumt.php 論壇首頁

如果你有開啟版區顯示話匣子功能時，下述檔名中的數字是代表各版的 fid

fid數字.php 及 fid數字t.php

每個版區用來存放記錄的檔案，是各自分開成，將這些也設 777 比較好。




上述安裝及使用說明，最後更新日期： 2012年7月24日
----------------------------------------------------





Ver 1.2，修改了不少地方，已用四種瀏覽器反覆測試n次，

不知還有無bug，如有發現可至下述論壇寄短訊：

http://www.discuz.net/  寄短訊給 warkinger
http://www.alan888.com/ 寄短訊給 warkinger

或至下述新浪網址回報：
http://blog.sina.com.cn/s/blog_a379ef0401013xag.html






















.